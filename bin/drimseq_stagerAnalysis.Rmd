---
title: "DRIMSeq stageR analysis"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r library, include=FALSE}
source("packrat/init.R")
library("dplyr")
library("readr")
library("DRIMSeq")
library("ggplot2")
```

```{r importData}
dmds <- read_rds(snakemake@input[["dmds"]])
biomart_gene <- read_rds(snakemake@input[["biomaRt_gene"]])
biomart_tx <- read_rds(snakemake@input[["biomaRt_tx"]])
res_stageR <- read_csv(snakemake@input[["res"]])
```

# Table of transcripts per gene after filtering.

```{r}
table(table(counts(dmds)$gene_id))
```

# Precision

```{r plotPrecision}
plotPrecision(dmds) +
    geom_point(size = 2) +
    scale_color_viridis_c()
```

```{r buildResultsTables}
res_gene <- DRIMSeq::results(dmds)
res_tx <- DRIMSeq::results(dmds, level = "feature")
```

# Results tables

## Gene Level

```{r kableDrimSeqResults_gene}
res_gene %>% 
    as_tibble() %>%
    arrange(adj_pvalue) %>% 
    filter(adj_pvalue < .05) %>% 
    dplyr::rename(ensembl_gene_id_version = "gene_id") %>% 
    left_join(biomart_gene, by = "ensembl_gene_id_version") %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

## Transcript level

```{r kableDrimSeqResults_tx}
res_tx %>% 
    as_tibble() %>%
    arrange(adj_pvalue) %>% 
    filter(adj_pvalue < .05) %>% 
    dplyr::rename(ensembl_gene_id_version = "gene_id",
        ensembl_transcript_id_version = "feature_id") %>% 
    left_join(biomart_tx, 
        by = c("ensembl_transcript_id_version", "ensembl_gene_id_version")) %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

## StageR

StageR looks at the pvalues for both genes and transcripts thereby allowing to 
control the overall false discovery rate. (While in the two tables aboth, the 
false discovery rate is controlled withing each table, it is not controlled over
both.)

```{r stageRresultsTables}
res_stageR %>%
    filter(gene < .05 | transcript < .05) %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

# Session info

```{r sessionInfo}
sessionInfo()
```
