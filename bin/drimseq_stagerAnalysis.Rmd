---
title: "DRIMSeq stageR analysis"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r library, include=FALSE}
source("packrat/init.R")
library("dplyr")
library("readr")
library("DRIMSeq")
library("ggplot2")
library("stageR")
BPPARAM = BiocParallel::MulticoreParam(snakemake@threads[[1]])
```


```{r importData}
dmds <- read_rds(snakemake@input[["dmds"]])

biomart_gene <- read_rds(snakemake@input[["biomaRt_gene"]])
biomart_tx <- read_rds(snakemake@input[["biomaRt_tx"]])
```

```{r filterLowlyExpressed, echo = TRUE}
# total number of samples
n <- 6
# number of samples in the smallest group
n.small <- 3

dmds <- dmFilter(dmds,
    min_samps_feature_expr = n.small, min_feature_expr = 10,
    min_samps_feature_prop = n.small, min_feature_prop = 0.1,
    min_samps_gene_expr = n, min_gene_expr = 10)
```

Table of transcripts per gene after filtering.

```{r}
table(table(counts(dmds)$gene_id))
```

# Run DrimSeq

```{r fitAndTestModels}
design_full <- model.matrix(~condition_temp, 
    data = DRIMSeq::samples(dmds) %>%
        mutate(condition_temp = relevel(condition_temp, "22")))

dmds <- dmPrecision(dmds, design = design_full, 
    BPPARAM = BPPARAM)
dmds <- dmFit(dmds, design = design_full)
dmds <- dmTest(dmds, coef = "condition_temp4")
```

```{r plotPrecision}
plotPrecision(dmds) +
    geom_point(size = 2) +
    scale_color_viridis_c()
```

```{r buildResultsTables}
res_gene <- DRIMSeq::results(dmds)
res_tx <- DRIMSeq::results(dmds, level="feature")
```

# Gene Level

```{r kableDrimSeqResults_gene}
res_gene %>% 
    as_tibble() %>%
    arrange(adj_pvalue) %>% 
    filter(adj_pvalue < .05) %>% 
    dplyr::rename(ensembl_gene_id_version = "gene_id") %>% 
    left_join(biomart_gene, by = "ensembl_gene_id_version") %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

# Transcript level

```{r kableDrimSeqResults_tx}
res_tx %>% 
    as_tibble() %>%
    arrange(adj_pvalue) %>% 
    filter(adj_pvalue < .05) %>% 
    dplyr::rename(ensembl_gene_id_version = "gene_id",
        ensembl_transcript_id_version = "feature_id") %>% 
    left_join(biomart_tx, 
        by = c("ensembl_transcript_id_version", "ensembl_gene_id_version")) %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

# StageR

```{r exchangeNAfor1}
no.na <- function(x) if_else(is.na(x), 1, x)

res_gene$pvalue <- no.na(res_gene$pvalue)
res_tx$pvalue <- no.na(res_tx$pvalue)
```

```{r stageRdataset}
# DrimSeq does not allow ':' in the names :-(
pScreen <- res_gene$pvalue
names(pScreen) <- sub(':', '_', res_gene$gene_id)

pConfirmation <- matrix(res_tx$pvalue, ncol = 1)
rownames(pConfirmation) <- res_tx$feature_id

tx2gene <- res_tx[ , c("feature_id", "gene_id")] %>% 
    mutate(gene_id = sub(':', '_', gene_id))

stageRObj <- stageRTx(pScreen = pScreen, pConfirmation = pConfirmation,
        pScreenAdjusted = FALSE, tx2gene = tx2gene)
stageRObj <- stageWiseAdjustment(stageRObj, method = "dtu", alpha = 0.05)

drim.padj <- getAdjustedPValues(stageRObj, order = TRUE,
    onlySignificantGenes = TRUE)
```

StageR looks at the pvalues for both genes and transcripts thereby allowing to 
control the overall false discovery rate. (While in the two tables aboth, the 
false discovery rate is controlled withing each table, it is not controlled over
both.)

```{r stageRresultsTables}
res_stageR <- drim.padj %>% 
    as_tibble() %>%
    dplyr::rename(ensembl_gene_id_version = "geneID",
        ensembl_transcript_id_version = "txID") %>% 
    left_join(biomart_gene, by = "ensembl_gene_id_version")

# Undo the name change
res_stageR <- res_stageR %>% 
    mutate(ensembl_gene_id_version = sub('_', ':', ensembl_gene_id_version))

res_stageR %>%
    filter(gene < .05 | transcript < .05) %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")

res_stageR %>% 
    write_csv(paste0(snakemake@params[["out_folder"]], "_drimSeqStageR.csv"))
```

# Session info

```{r sessionInfo}
sessionInfo()
```
