---
title: "Nanopore iBAT, Coverage"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r}
save.image("coverage.RData")
```


```{r loadPackages}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
library("AnnotationDbi")
```

```{r}
sample_info <- read_csv(snakemake@input[["sample_info"]]) %>% 
    filter(!is.na(ont)) %>%
    mutate_at(vars(matches("condition")), as.factor) %>% 
    dplyr::select(sample_id, illumina, ont)
```

# Gene body coverage

```{r dataImport_geneBodyCoverage}
read_geneBodyCoverage <- function(file) {
    file %>% 
        read_tsv() %>%
        tidyr::gather() %>% 
        magrittr::set_colnames(.[1, ]) %>% 
        `[`(-1, ) %>% 
        mutate_all(as.integer)
}

prepare_dataset = function(files, name) {
    files %>% 
        map(read_geneBodyCoverage) %>% 
        purrr::reduce(left_join, by = "Percentile") %>% 
        tidyr::gather("sample", "n", -Percentile) %>% 
        mutate(dataset = name)
}

illumina <- snakemake@input[["geneBodyCoverage_illumina"]] %>% 
    prepare_dataset(name = "illumina") %>% 
    mutate(sample = substr(sample, 2, 9)) %>% 
    left_join(sample_info, by = c("sample" = "illumina")) %>% 
    dplyr::select(-sample, -ont)
    
teloprime <- snakemake@input[["geneBodyCoverage_teloprime"]] %>% 
    prepare_dataset(name = "teloprime") %>% 
    mutate(sample = substr(sample, 1, 9)) %>% 
    left_join(sample_info, by = c("sample" = "ont")) %>% 
    dplyr::select(-sample, -illumina)

```

```{r plot_geneBodyCoverage}
list(illumina, teloprime) %>% 
    bind_rows() %>%
    group_by(dataset, sample_id) %>% 
    mutate(p = n / max(n)) %>% 
    ungroup() %>% 
    ggplot(aes(Percentile, p)) +
        geom_line(aes(colour = dataset, lty = sample_id)) +
        theme_tufte() +
        geom_rangeframe(sides = "bl") +
        xlab("Gene body percentile (5' -> 3')") +
        ylab("Coverage") +
        scale_color_viridis_d()
```

# Coverage

```{r}
teloprime <- snakemake@input[["coverage_teloprime"]] %>% 
    map(read_rds)
```



