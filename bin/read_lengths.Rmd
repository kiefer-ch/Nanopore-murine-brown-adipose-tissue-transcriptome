---
title: "Nanopore iBAT, Read lengths etc"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r}
save.image("read_lengths.RData")
```


```{r loadPackages}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
```

```{r dataImport_tx}
get_map_type <- function(flag) {
    if_else(flag %in% c(0, 16), "primary",
        if_else(flag %in% c(256, 275), "secondary", "supplementary"))
}

tx <- snakemake@input %>% 
    unlist() %>% 
    tibble::enframe() %>% 
    filter(grepl("transcriptome", value)) %>% 
    tibble::deframe()

df_tx <- tx %>%
    as.list() %>% 
    set_names(tx) %>% 
    map(read_rds) %>%     
    map(mutate, type = get_map_type(flag)) %>% 
    map(select, -seqnames) %>% 
    bind_rows(.id = "sample")
```

```{r dataImport_fastq}
df <- read_csv(snakemake@input[["teloprime_readLengths"]]) %>%
    tidyr::gather("sample", "counts", -read_length) %>% 
    tidyr::separate(sample, c("waste1", "waste2", "flowcell", "waste3", "barcode"), 
        extra = "drop") %>% 
    select_at(vars(-matches("waste"))) 
```

# Length of reads per sample and flowcell

Read lengths from fastq files

```{r}
df %>% 
    group_by(flowcell, barcode) %>% 
    mutate(weight = counts / sum(counts)) %>% 
    ungroup() %>% 
    ggplot(aes(barcode, read_length, weight = weight, fill = flowcell)) +
    geom_violin() +
    scale_y_log10() +
    scale_fill_viridis_d() +
    theme_tufte() +
    geom_rangeframe(sides = "l") +
    xlab(NULL) + 
    ylab("Read length")
```

# Reads and mapping

```{r}
mapping_df <- df_tx %>% 
    select(qname, type) %>% 
    group_by(qname) %>% 
    summarise(has_primary = any(type == "primary"),
        has_supplementary = any(type == "supplementary"))

mapping_df2 <- mapping_df %>% 
    summarise(n_primary = sum(has_primary),
        n_supplementary = sum(has_supplementary)) %>% 
    tidyr::gather("type", "count") %>% 
    add_row(type = "n_total", count = sum(df$counts)) %>% 
    mutate(method = "teloprime") %>% 
    group_by(method) %>% 
    mutate(p = count/count[type == "n_total"]) %>% 
    ungroup()

mapping_df2 %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling()

mapping_df2 %>% 
    mutate(type = factor(type, levels = c("n_total", "n_primary", "n_supplementary"))) %>% 
    ggplot(aes(x = method, y = count,  fill = type)) +
    geom_bar(stat = "identity", position=position_dodge()) +
    theme_tufte() +
    geom_rangeframe(sides = "l") +
    xlab(NULL) + 
    ylab("Reads")
```

## Length of primary and supplementary reads

```{r}
df_tx %>% 
    select(-sample, -flag) %>% 
    left_join(mapping_df, by = "qname") %>% 
    mutate(category = if_else(type == "supplementary", "supplementary",
        if_else(has_supplementary, "primary_with_supplementary", "primary_wo_supplementary"))) %>% 
    ggplot(aes(category, qwidth)) + 
    geom_violin() +
    scale_y_log10() +
    theme_tufte() +
    geom_rangeframe(sides = "l") +
    xlab(NULL) + 
    ylab("Read length")

df_tx %>% 
    select(-sample, -flag) %>% 
    left_join(mapping_df, by = "qname") %>% 
    mutate(category = if_else(type == "supplementary", "supplementary",
        if_else(has_supplementary, "primary_with_supplementary", "primary_wo_supplementary"))) %>% 
    ggplot(aes(category, aligned)) + 
    geom_violin() +
    scale_y_log10() +
    theme_tufte() +
    geom_rangeframe(sides = "l") +
    xlab(NULL) + 
    ylab("Aligned read length")
```


# Transcriptome

## Aligned length vs read length

Primary hits only

```{r plotTranscriptome}
df_tx %>% 
    filter(type == "primary") %>% 
    ggplot(aes(qwidth, aligned)) +
    geom_hex(aes(fill = ..density..), binwidth = .025) +
    scale_x_log10() +
    scale_y_log10() +
    scale_fill_viridis_c(trans = "log") +
    geom_abline(slope = 1) +
    theme_tufte() +
    geom_rangeframe(sides = "bl") +
    xlab("Read Length") + 
    ylab("Aligned Length") 
```

# Genome

```{r dataImport_genome, eval=FALSE}
rm(df_tx)

genome <- snakemake@input %>% 
    unlist() %>% 
    tibble::enframe() %>% 
    filter(!grepl("transcriptome", value)) %>% 
    tibble::deframe()

df_genome <- genome %>%
    as.list() %>% 
    set_names(genome) %>% 
    map(read_rds) %>%     
    map(mutate, type = get_map_type(flag)) %>% 
    map(select, -seqnames) %>% 
    bind_rows(.id = "sample")
```

## Aligned length vs read length

Primary hits only

```{r plotGenome, eval=FALSE}
df_genome %>% 
    filter(type == "primary") %>% 
    ggplot(aes(qwidth, aligned)) +
    geom_hex(aes(fill = ..density..), binwidth = .025) +
    scale_x_log10() +
    scale_y_log10() +
    scale_fill_viridis_c(trans = "log") +
    geom_abline(slope = 1) +
    theme_tufte() +
    geom_rangeframe(sides = "bl") +
    xlab("Read Length") + 
    ylab("Aligned Length") 
```
