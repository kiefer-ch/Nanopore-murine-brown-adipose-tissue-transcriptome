---
title: "Nanopore iBAT, expression levels by technology"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r loadPackages}
source(".Rprofile")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
library("ggpmisc")
library("scales")
    rename <- dplyr::rename
    select <- dplyr::select
```

```{r importData}
df_gene_average <- read_csv(snakemake@input[["gene"]]) %>%
    tidyr::gather("dataset", "average_counts",  -ensembl_gene_id_version, -mgi_symbol, -description,
        -gene_biotype, -grouped_biotype)

df_tx_average <- read_csv(snakemake@input[["tx"]]) %>% 
    tidyr::gather("dataset", "average_counts",  -ensembl_transcript_id_version,
        -ensembl_gene_id_version, -mgi_symbol, -description, -gene_biotype,
        -transcript_biotype, -transcript_length, -grouped_biotype)
```


```{r}
mylog10_trans <- function (base = 10) {
  trans <- function(x) log(x + 1, base)
  inv <- function(x) base^x - 1
  trans_new(paste0("log-", format(base)), trans, inv, log_breaks(base = base), 
            domain = c(1e-100, Inf))
}
```

# Illumina vs teloprime

## Genes

```{r}
df_gene_average %>% 
    filter(dataset %in% c("illumina", "teloprime")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, teloprime)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average teloprime counts")
```

## Transcripts

```{r}
df_tx_average %>% 
    filter(dataset %in% c("illumina", "teloprime")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, teloprime)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average teloprime counts")
```

# Illumina vs direct cDNA

## Genes

```{r}
df_gene_average %>% 
    filter(dataset %in% c("illumina", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average direct cDNA counts")
```

## Transcripts

```{r}
df_tx_average %>% 
    filter(dataset %in% c("illumina", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average direct cDNA counts")
```

# Teloprime vs direct cDNA

## Genes

```{r}
df_gene_average %>% 
    filter(dataset %in% c("teloprime", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(teloprime, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average teloprime counts") +
    ylab("Average direct cDNA counts")
```

## Transcripts

```{r}
df_tx_average %>% 
    filter(dataset %in% c("teloprime", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(teloprime, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average teloprime counts") +
    ylab("Average direct cDNA counts")
```
