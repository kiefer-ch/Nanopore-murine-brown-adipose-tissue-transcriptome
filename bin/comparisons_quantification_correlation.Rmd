---
title: "Nanopore iBAT, expression levels by technology"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
        fig_caption: false
        dev: "png"
editor_options:
    chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r loadPackages}
source(".Rprofile")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
library("ggpmisc")
library("scales")
library("GGally")
    rename <- dplyr::rename
    select <- dplyr::select
```

```{r importData}
df_gene_average <- read_csv(snakemake@input[["gene_avg"]]) %>%
    tidyr::gather("dataset", "average_counts",  -ensembl_gene_id_version, -mgi_symbol, -description,
        -gene_biotype, -grouped_biotype) %>% 
    mutate(average_counts = 2^average_counts - 1)

df_tx_average <- read_csv(snakemake@input[["tx_avg"]]) %>% 
    tidyr::gather("dataset", "average_counts",  -ensembl_transcript_id_version,
        -ensembl_gene_id_version, -mgi_symbol, -description, -gene_biotype,
        -transcript_biotype, -transcript_length, -grouped_biotype) %>% 
     mutate(average_counts = 2^average_counts - 1)
```


```{r}
mylog10_trans <- function (base = 10) {
  trans <- function(x) log(x + 1, base)
  inv <- function(x) base^x - 1
  trans_new(paste0("log-", format(base)), trans, inv, log_breaks(base = base), 
            domain = c(1e-100, Inf))
}
```

# Average expression over all datasets

## Genes
```{r}
df_axis <- tibble(x = rep(c("cdna", "illumina", "rna"), c(3, 2, 1)),
    y = c("illumina", "rna", "teloprime", "rna", "teloprime", "teloprime"))

pl_list <- vector("list", nrow(df_axis))

for (i in 1:nrow(df_axis)) {
    x <- df_axis$x[i]
    y <- df_axis$y[i]
    
    if (x == "illumina") {
        x_lab <- "Average illumina tpm"
    } else {
        x_lab <- sprintf("Average %s counts", x)
    }
    
    if (y == "illumina") {
        y_lab <- "Average illumina tpm"
    } else {
        y_lab <- sprintf("Average %s counts", y)
    }
    
    x <- sym(x)
    y <- sym(y)
    
    pl_list[[i]] <- df_gene_average %>% 
        filter(dataset %in% c(x, y)) %>% 
        tidyr::spread(dataset, average_counts) %>%
        tidyr::drop_na() %>% 
        ggplot(aes(x = !! x, y = !! y)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        xlab(x_lab) +
        ylab(y_lab)
}

pl <- ggmatrix(pl_list, ncol = 3, nrow = 3,
    xAxisLabels = c("Average cDNA counts", "Average illumina tpm", "Average rna counts"),
    yAxisLabels = c("Average illumina tpm", "Average rna counts", "Average teloprime counts"),
    legend = c(3,1))
pl[1, 2] <- NULL
pl[1, 3] <- NULL
pl[2, 3] <- NULL
pl[2, 1] <- pl_list[[2]]
pl[3, 1] <- pl_list[[3]]
pl[2, 2] <- pl_list[[4]]
pl[3, 2] <- pl_list[[5]]
pl[3, 3] <- pl_list[[6]]
pl
```

## Transcripts

```{r}
pl_list <- vector("list", nrow(df_axis))

for (i in 1:nrow(df_axis)) {
    x <- df_axis$x[i]
    y <- df_axis$y[i]
    
    if (x == "illumina") {
        x_lab <- "Average illumina tpm"
    } else {
        x_lab <- sprintf("Average %s counts", x)
    }
    
    if (y == "illumina") {
        y_lab <- "Average illumina tpm"
    } else {
        y_lab <- sprintf("Average %s counts", y)
    }
    
    x <- sym(x)
    y <- sym(y)
    
    pl_list[[i]] <- df_tx_average %>% 
        filter(dataset %in% c(x, y)) %>% 
        tidyr::spread(dataset, average_counts) %>%
        tidyr::drop_na() %>% 
        ggplot(aes(x = !! x, y = !! y)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Transcript biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        xlab(x_lab) +
        ylab(y_lab)
}

pl <- ggmatrix(pl_list, ncol = 3, nrow = 3,
    xAxisLabels = c("Average cDNA counts", "Average illumina tpm", "Average rna counts"),
    yAxisLabels = c("Average illumina tpm", "Average rna counts", "Average teloprime counts"),
    legend = c(3,1))
pl[1, 2] <- NULL
pl[1, 3] <- NULL
pl[2, 3] <- NULL
pl[2, 1] <- pl_list[[2]]
pl[3, 1] <- pl_list[[3]]
pl[2, 2] <- pl_list[[4]]
pl[3, 2] <- pl_list[[5]]
pl[3, 3] <- pl_list[[6]]
pl
```

# Sample wise comparison

```{r importData2}
df_gene <- read_csv(snakemake@input[["gene"]]) %>% 
    filter(!sample_id %in% c("cool", "rt")) %>% 
    mutate_if(is.numeric, function(x) 2^x - 1)

df_tx <- read_csv(snakemake@input[["tx"]]) %>%
    filter(!sample_id %in% c("cool", "rt")) %>% 
    mutate_if(is.numeric, function(x) 2^x - 1)
```

## Genes

### cDNA vs Illumina

```{r}
df_gene %>% 
    select(ensembl_gene_id_version, sample_id, grouped_biotype, cdna, illumina) %>% 
    tidyr::drop_na() %>% 
    ggplot(aes(cdna, illumina)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        facet_wrap(~sample_id) +
        xlab("cDNA counts") +
        ylab("Illumina tpm")
```

### cDNA vs teloprime

```{r}
df_gene %>% 
    select(ensembl_gene_id_version, sample_id, grouped_biotype, cdna, teloprime) %>% 
    tidyr::drop_na() %>% 
    ggplot(aes(cdna, teloprime)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        facet_wrap(~sample_id) +
        xlab("cDNA counts") +
        ylab("Teloprime counts")
```

### Illumina vs teloprime

```{r}
df_gene %>% 
    select(ensembl_gene_id_version, sample_id, grouped_biotype, illumina, teloprime) %>% 
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, teloprime)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        facet_wrap(~sample_id) +
        xlab("Illumina tpm") +
        ylab("Teloprime counts")
```

## Transcripts

### cDNA vs Illumina

```{r}
df_tx %>% 
    select(ensembl_transcript_id_version, sample_id, grouped_biotype, cdna, illumina) %>% 
    tidyr::drop_na() %>% 
    ggplot(aes(cdna, illumina)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        facet_wrap(~sample_id) +
        xlab("cDNA counts") +
        ylab("Illumina tpm")
```

### cDNA vs teloprime

```{r}
df_tx %>% 
    select(ensembl_transcript_id_version, sample_id, grouped_biotype, cdna, teloprime) %>% 
    tidyr::drop_na() %>% 
    ggplot(aes(cdna, teloprime)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        facet_wrap(~sample_id) +
        xlab("cDNA counts") +
        ylab("Teloprime counts")
```

### Illumina vs teloprime

```{r}
df_tx %>% 
    select(ensembl_transcript_id_version, sample_id, grouped_biotype, illumina, teloprime) %>% 
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, teloprime)) +
        geom_point(aes(colour = grouped_biotype), size = 1) +
        geom_abline(slope = 1, lty = 2) +
        stat_poly_eq(formula = y ~ x,
            aes(label = paste(..rr.label.., sep = "~~~")),
            parse = TRUE, family = "serif", size = 3, colour = "grey30",
            label.x.npc = "left", label.y.npc = "top") +
        scale_x_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_y_continuous(
            breaks = c(1, 10, 100, 1000, 10000),
            labels = function(x) signif(x),
            trans = "mylog10") +
        scale_colour_colorblind(name = "Gene biotype") +
        theme_tufte() +
        geom_rangeframe(sides = 'bl', na.rm = FALSE) +
        facet_wrap(~sample_id) +
        xlab("Illumina tpm") +
        ylab("Teloprime counts")
```
