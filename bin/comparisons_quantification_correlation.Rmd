---
title: "Nanopore iBAT, expression levels by technology"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r loadPackages}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
library("ggpmisc")
library("scales")
    rename <- dplyr::rename
    select <- dplyr::select
```

```{r importData}
# biomart
biomaRt_tx <- read_rds(snakemake@input[["biomaRt_tx"]])
biomaRt_gene <- read_rds(snakemake@input[["biomaRt_gene"]])
biotype_groups <- read_csv(snakemake@input[["biotype_groups"]])

# gene level
df_gene <- c(snakemake@input[["gene_counts"]], snakemake@input[["gene_tpm"]]) %>% 
    set_names(basename(.)) %>% 
    map(read_csv) %>%
    map(select, -mgi_symbol, -description, -gene_biotype) %>% 
    map(tidyr::gather, key = "sample_id", value = "counts", -ensembl_gene_id_version) %>% 
    bind_rows(.id = "dataset") %>% 
    tidyr::separate(dataset, "dataset", extra = "drop")

df_gene_average <- df_gene %>% 
    group_by(dataset, ensembl_gene_id_version) %>% 
    summarise(average_counts = mean(counts)) %>% 
    left_join(biomaRt_gene, by = "ensembl_gene_id_version") %>% 
    left_join(biotype_groups, by = c("gene_biotype" = "transcript_biotype"))

# tx level
df_tx <- c(snakemake@input[["tx_counts"]], snakemake@input[["tx_tpm"]]) %>% 
    set_names(basename(.)) %>% 
    map(read_csv) %>%
    map(select, -mgi_symbol, -description, -gene_biotype, -transcript_biotype, -transcript_length) %>% 
    map(tidyr::gather, key = "sample_id", value = "counts", 
        -ensembl_gene_id_version, -ensembl_transcript_id_version) %>% 
    bind_rows(.id = "dataset") %>% 
    tidyr::separate(dataset, "dataset", extra = "drop")

df_tx_average <- df_tx %>% 
    group_by(dataset, ensembl_transcript_id_version) %>% 
    summarise(average_counts = mean(counts)) %>% 
    left_join(biomaRt_tx, by = "ensembl_transcript_id_version") %>% 
    left_join(biotype_groups, by = "transcript_biotype")
```

```{r}
mylog10_trans <- function (base = 10) {
  trans <- function(x) log(x + 1, base)
  inv <- function(x) base^x - 1
  trans_new(paste0("log-", format(base)), trans, inv, log_breaks(base = base), 
            domain = c(1e-100, Inf))
}
```

# Illumina vs teloprime

## Genes

```{r}
df_gene_average %>% 
    filter(dataset %in% c("illumina", "teloprime")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, teloprime)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average teloprime counts")
```

## Transcripts

```{r}
df_tx_average %>% 
    filter(dataset %in% c("illumina", "teloprime")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, teloprime)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average teloprime counts")
```

# Illumina vs direct cDNA

## Genes

```{r}
df_gene_average %>% 
    filter(dataset %in% c("illumina", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average direct cDNA counts")
```

## Transcripts

```{r}
df_tx_average %>% 
    filter(dataset %in% c("illumina", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(illumina, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average illumina tpm") +
    ylab("Average direct cDNA counts")
```

# Teloprime vs direct cDNA

## Genes

```{r}
df_gene_average %>% 
    filter(dataset %in% c("teloprime", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(teloprime, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average teloprime counts") +
    ylab("Average direct cDNA counts")
```

## Transcripts

```{r}
df_tx_average %>% 
    filter(dataset %in% c("teloprime", "cdna")) %>% 
    mutate(average_counts = 2^average_counts - 1) %>% 
    tidyr::spread(dataset, average_counts) %>%
    tidyr::drop_na() %>% 
    ggplot(aes(teloprime, cdna)) +
    geom_point(aes(colour = grouped_biotype))  +
    geom_abline(slope = 1, lty = 2) +
    stat_poly_eq(formula = y ~ x,
        aes(label = paste(..rr.label.., sep = "~~~")),
        parse = TRUE, family = "serif", size = 3, colour = "grey30",
        label.x.npc = "left", label.y.npc = "top") +
    scale_x_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_y_continuous(
        breaks = c(.1, 1, 10, 100, 1000, 10000),
        labels = function(x) signif(x),
        trans = "mylog10") +
    scale_colour_colorblind(name = "Gene biotype") +
    theme_tufte() +
    geom_rangeframe(sides = 'bl', na.rm = FALSE) +
    xlab("Average teloprime counts") +
    ylab("Average direct cDNA counts")
```
