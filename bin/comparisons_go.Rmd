---
title: "Comparison of GO terms by illumina and ont, gene and tx level"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
        fig_caption: false
        dev: "svg"
editor_options:
    chunk_output_type: console
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE)
```

```{r library, include=FALSE, cache=FALSE}
source(".Rprofile")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("UpSetR")
```

```{r dataImport_illumina}
df_go <- snakemake@input[["go"]] %>%
    set_names(., sub("_apeglm_topgo", '', tools::file_path_sans_ext(basename(.), compression = TRUE))) %>%
    map(read_rds) %>% 
    map(bind_rows, .id = "regulation") %>%
    bind_rows(.id = "dataset") %>% 
    tidyr::unite(method, dataset, regulation) %>% 
    tidyr::unite(go, GO.ID, Term) %>% 
    select(-Annotated, -Significant, -Expected)
```

# All datasets

## Seperated up/down

```{r upset_all_separated}
df_go %>%
    tidyr::spread(method, p) %>%
    mutate_if(is.numeric, tidyr::replace_na, 1) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < snakemake@params[["cutoff"]])) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("go") %>%
    upset(nsets = 10, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq")
```

## Combined up/down

```{r upset_all_combined}
df_go %>% 
    tidyr::separate(method, c("dataset", "level", "regulation")) %>% 
    group_by(dataset, level, go) %>% 
    summarise(p = min(p)) %>% 
    tidyr::unite(method, dataset, level) %>% 
    tidyr::spread(method, p) %>%
    mutate_if(is.numeric, tidyr::replace_na, 1) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < snakemake@params[["cutoff"]])) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("go") %>%
    upset(nsets = 10, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq")
```

# Only genelevel

## Seperated up/down

```{r upset_gene_seperated}
df_go %>% 
    filter(grepl("gene", .$method)) %>% 
    tidyr::spread(method, p) %>%
    mutate_if(is.numeric, tidyr::replace_na, 1) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < snakemake@params[["cutoff"]])) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("go") %>%
    upset(nsets = 10, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq")
```

## Combined up/down

```{r upset_gene_combined}
df_go %>% 
    filter(grepl("gene", .$method)) %>% 
    tidyr::separate(method, c("dataset", "level", "regulation")) %>% 
    group_by(dataset, level, go) %>% 
    summarise(p = min(p)) %>% 
    tidyr::unite(method, dataset, level) %>% 
    tidyr::spread(method, p) %>%
    mutate_if(is.numeric, tidyr::replace_na, 1) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < snakemake@params[["cutoff"]])) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("go") %>%
    upset(nsets = 10, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq")
```
