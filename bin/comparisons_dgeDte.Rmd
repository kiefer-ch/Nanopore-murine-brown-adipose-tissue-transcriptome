---
title: "Comparison of DGE and DTE"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
        fig_caption: false
        dev: "svg"
editor_options:
    chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
    cache = FALSE, out.width = 800)
```

```{r library, include=FALSE}
source(".Rprofile")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
library("UpSetR")
library("scales")
library("patchwork")
    select <- dplyr::select
    rename <- dplyr::rename
```

```{r dataImport}
dte <- snakemake@input[["dte"]] %>%
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>%
    map(read_csv, show_col_types = FALSE) %>%
    bind_rows(.id = "dataset") %>%
    select(-mgi_symbol, -description, -lfcSE, -baseMean, -log2FoldChange) %>%
    tidyr::separate(dataset, c("dataset", "library"), extra = "drop") %>%
    tidyr::unite("method", dataset, library) %>%
    tidyr::spread(method, svalue) %>%
    mutate_if(is.numeric, tidyr::replace_na, 1)

dge <- snakemake@input[["dge"]] %>%
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>%
    map(read_csv, show_col_types = FALSE) %>%
    bind_rows(.id = "dataset") %>%
    select(-mgi_symbol, -description, -lfcSE, -baseMean, -log2FoldChange) %>%
    tidyr::separate(dataset, c("dataset", "library"), extra = "drop") %>%
    tidyr::unite("method", dataset, library) %>%
    tidyr::spread(method, svalue) %>%
    mutate_if(is.numeric, tidyr::replace_na, 1)

df_gene <- snakemake@input[["gene_counts"]] %>%
    set_names(basename(.)) %>%
    map(read_csv, show_col_types = FALSE) %>%
    map(select, -mgi_symbol, -description, -gene_biotype) %>%
    map(tidyr::gather, key = "sample_id", value = "counts", -ensembl_gene_id_version) %>%
    bind_rows(.id = "dataset") %>%
    tidyr::separate(dataset, "dataset", extra = "drop")

# df_tx <- snakemake@input[["tx_counts"]] %>%
#     set_names(basename(.)) %>%
#     map(read_csv, show_col_types = FALSE) %>%
#     map(select, -mgi_symbol, -description, -gene_biotype, -transcript_biotype, -transcript_length) %>%
#     map(tidyr::gather, key = "sample_id", value = "counts",
#         -ensembl_gene_id_version, -ensembl_transcript_id_version) %>%
#     bind_rows(.id = "dataset") %>%
#     tidyr::separate(dataset, "dataset", extra = "drop")

biotype_groups <- read_csv(snakemake@input[["grouped_biotypes"]], show_col_types = FALSE)
```

```{r filteringForExpression}
expressed_genes <- df_gene %>%
    group_by(ensembl_gene_id_version, dataset) %>%
    summarize(is_expressed = if_else(sum(counts) > 5, TRUE, FALSE)) %>%
    summarise(is_expressed_all = if_else(sum(is_expressed) == 3, TRUE, FALSE)) %>%
    filter(is_expressed_all) %>%
    pull(ensembl_gene_id_version)

# expressed_transcripts <- df_tx %>%
#     group_by(ensembl_transcript_id_version, dataset) %>%
#     summarize(is_expressed = if_else(sum(counts) > 5, TRUE, FALSE)) %>%
#     summarise(is_expressed_all = if_else(sum(is_expressed) == 3, TRUE, FALSE)) %>%
#     filter(is_expressed_all) %>%
#     pull(ensembl_transcript_id_version)
```


# Intersections

## DGE

Analysis on gene level. The txlevel pvalues are the smallest for any of the transcripts
of a gene.

```{r mergeTx}
dte_grouped <- dte %>%
    group_by(ensembl_gene_id_version) %>%
    summarise_if(is.numeric, min) %>%
    select(-transcript_length)

df <- dge %>%
    full_join(dte_grouped, by = "ensembl_gene_id_version") %>%
    mutate_if(is.numeric, tidyr::replace_na, 1)
```

## All genes

```{r upset}
df %>%
    select(-gene_biotype) %>%
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    tidyr::drop_na(ensembl_gene_id_version) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 6, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq",
        sets = c("illumina_genelevel", "illumina_txlevel", "teloprime_genelevel", "teloprime_txlevel", "cdna_genelevel", "cdna_txlevel"),
        sets.x.label = "Diff. expr. features",
        mainbar.y.label = "Shared diff. expr. features",
        text.scale = 1.5)
```

## Protein coding only

```{r}
df %>%
    filter(gene_biotype == "protein_coding") %>%
    select(-gene_biotype) %>%
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    tidyr::drop_na(ensembl_gene_id_version) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>%
    upset(nsets = 6, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq")
```

## Only genes, that were detected by both datasets

```{r}
df %>%
    filter(ensembl_gene_id_version %in% expressed_genes) %>%
    select(-gene_biotype) %>%
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    tidyr::drop_na(ensembl_gene_id_version) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>%
    upset(nsets = 6, keep.order = TRUE,
        nintersects = 15,
        order.by = "freq")
```


# Biotypes

```{r}
pl_gene <- dge %>%
    left_join(biotype_groups, by = c("gene_biotype" = "transcript_biotype")) %>%
    select(-gene_biotype) %>%
    tidyr::drop_na(grouped_biotype) %>%
    tidyr::gather("library", "svalue", -grouped_biotype, -ensembl_gene_id_version) %>%
    filter(svalue < .05) %>%
    tidyr::separate(library, "library", extra = "drop") %>% 
    group_by(library, grouped_biotype) %>% 
    summarise(count = n()) %>% 
    mutate(fraction = count/sum(count)) %>% 
    mutate(library = factor(library, levels = c("illumina", "teloprime", "cdna", "rna"))) %>% 
    mutate(grouped_biotype = factor(grouped_biotype, 
        levels = c("coding", "long ncRNA", "pseudogenes", "processed_others", "others"))) %>% 
    ggplot(aes(library, fraction)) +
        geom_bar(aes(fill = grouped_biotype), stat = "identity") +
        scale_fill_brewer(palette = "Dark2", name = NULL, drop = FALSE) +
        theme_tufte(base_size = 8, base_family = "Helvetica") +
        geom_rangeframe(sides = 'lb', stat = "identity") +
        scale_y_continuous(labels = label_percent()) +
        xlab(NULL) +
        ylab("Diff. expr. genes") +
        theme(legend.key.size = unit(.33, "cm")) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r}
pl_tx <- dte %>%
    left_join(biotype_groups, by = "transcript_biotype") %>%
    select(-transcript_biotype, -transcript_length, -ensembl_gene_id_version,
        -gene_biotype) %>%
    tidyr::drop_na(grouped_biotype) %>%
    tidyr::gather("library", "svalue", -grouped_biotype, -ensembl_transcript_id_version) %>%
    filter(svalue < .05) %>%
    tidyr::separate(library, "library", extra = "drop") %>%
    group_by(library, grouped_biotype) %>% 
    summarise(count = n()) %>% 
    mutate(fraction = count/sum(count)) %>% 
    mutate(library = factor(library, levels = c("illumina", "teloprime", "cdna", "rna"))) %>% 
    mutate(grouped_biotype = factor(grouped_biotype, 
        levels = c("coding", "long ncRNA", "pseudogenes", "processed_others", "others"))) %>% 
        ggplot(aes(library, fraction)) +
        geom_bar(aes(fill = grouped_biotype), stat = "identity") +
        scale_fill_brewer(palette = "Dark2", name = NULL) +
        theme_tufte(base_size = 8, base_family = "Helvetica") +
        geom_rangeframe(sides = 'lb', stat = "identity") +
        scale_y_continuous(labels = label_percent()) +
        xlab(NULL) +
        ylab("Diff. expr. transcripts") +
        theme(legend.key.size = unit(.33, "cm")) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r plot, , fig.width = 6.85 / 2, fig.asp = .7}
pl_gene + pl_tx +  plot_layout(guides = 'collect')
```

