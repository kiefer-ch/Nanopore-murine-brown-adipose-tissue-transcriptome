---
title: "Comparison of GO terms by illumina and ont, gene and tx level"
author: "Christoph Kiefer"
date: "20. September 2019"
output:
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE)
```

```{r library, include=FALSE, cache=FALSE}
source(".Rprofile")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggiraph")
library("UpSetR")
library("DESeq2")
library("topGO")
library("ReactomePA")
    select <- dplyr::select
    rename <- dplyr::rename
```

```{r dataImport_illumina}
illumina_tx <- "../res/txlevel_ont/txlevel_ont_de.csv.gz"
illumina_gene <- "../res/genelevel_ont/genelevel_ont_de.csv.gz"

data <- c(illumina_tx, illumina_gene) %>%
    map(read_csv)
```

```{r dataImport_ont}
# read counts
ont <- "../res/wien/6samples/ChrKiefer_6samples_raw_gene_counts.tsv"
ont_df <- read_tsv(ont) %>%
    tidyr::separate(transcript,
        c("ensembl_transcript_id_version", "ensembl_gene_id_version"),
        sep = '\\|')

# rename
sample_info <- read_csv("../sample_info/sampleInfo.csv")

lookup <- sample_info$illumina
names(lookup) <- sample_info$ont

colnames(ont_df) <- lookup[colnames(ont_df)]
colnames(ont_df)[c(1, 2)] <- c("ensembl_transcript_id_version", "ensembl_gene_id_version")

# prepare colData
colData <- sample_info %>%
    mutate_all(as.factor) %>%
    filter(!is.na(ont)) %>%
    as.data.frame() %>%
    magrittr::set_rownames(.$illumina)
```

```{r deseqTx}
# dds tx level
ont_counts <- as.matrix(ont_df[, c(-1, -2)])
row.names(ont_counts) <- ont_df$ensembl_transcript_id_version

dds_tx <- DESeqDataSetFromMatrix(ont_counts, colData, design = ~ condition_temp)

colData(dds_tx)$condition_temp <- relevel(colData(dds_tx)$condition_temp, ref = "22")

# filtering lowly expressed genes and fitting models
dds_tx <- dds_tx[rowSums(counts(dds_tx)) > 10, ] %>%
    DESeq(., parallel = TRUE)

resLFC_tx <- lfcShrink(dds_tx,
    coef = "condition_temp_4_vs_22",
    lfcThreshold = 1,
    type = "apeglm",
    parallel = TRUE)

resLFC_tx <- resLFC_tx %>%
    as_tibble(rownames = "ensembl_tx_id_version")

lookup <- ont_df$ensembl_gene_id_version
names(lookup) <- ont_df$ensembl_transcript_id_version

resLFC_tx <- resLFC_tx %>%
    mutate(ensembl_gene_id_version = lookup[ensembl_tx_id_version])
```

```{r deseqGene}
# dds tx level
ont_counts <- ont_df %>%
    tidyr::gather(key = "sample", value = "counts_ont",
        -ensembl_transcript_id_version, -ensembl_gene_id_version) %>%
    group_by(ensembl_gene_id_version, sample) %>%
    summarise(counts_ont = sum(counts_ont)) %>%
    tidyr::spread(key = sample, value = counts_ont) %>%
    filter(!is.na(ensembl_gene_id_version)) %>%
    magrittr::set_rownames(.$ensembl_gene_id_version) %>%
    as.matrix() %>%
    `[`( ,-1)

class(ont_counts) <- "numeric"

dds_gene <- DESeqDataSetFromMatrix(ont_counts, colData, design = ~ condition_temp)
colData(dds_gene)$condition_temp <- relevel(colData(dds_gene)$condition_temp, ref = "22")

# filtering lowly expressed genes and fitting models
dds_gene <- dds_gene[rowSums(counts(dds_gene)) > 10, ] %>%
    DESeq(., parallel = TRUE)

resLFC_gene <- lfcShrink(dds_gene,
    coef = "condition_temp_4_vs_22",
    lfcThreshold = 1,
    type = "apeglm",
    parallel = TRUE)

resLFC_gene <- resLFC_gene %>%
    as_tibble(rownames = "ensembl_gene_id_version")
```


```{r mergeDatasets}
data[[4]] <- resLFC_gene
data[[3]] <- resLFC_tx

data <- data %>%
    set_names(c("illumina_tx", "illumina_gene", "ont_tx", "ont_gene"))
```

# GO

```{r goAnalysisFunctions}
# reference for the GO analysis are all expressed genes
get.geneList <- function(df) {
    all_genes <- df$ensembl_gene_id_version
    signif <- df %>%
        filter(svalue < .05) %>%
        pull(ensembl_gene_id_version)

    gl <- as.factor(as.integer(all_genes %in% signif))
    names(gl) <- all_genes
    # remove version
    names(gl) <- unlist(lapply(stringr::str_split(names(gl), "[.]"), "[[",1))
    gl
}

# function to actually create topGO object
make.topGO <- function(geneList, description) {
    new("topGOdata",
        description = description,
        ontology = "BP",
        allGenes = geneList,
        nodeSize = 10,
        annot = annFUN.org,
        ID = "ensembl",
        mapping = "org.Mm.eg")
}

# conveniance function to get results from topGO
get.results <- function(topGO) {
    topGOres <- runTest(topGO, algorithm = "parentchild", statistic = "fisher")
    GenTable(topGO, p = topGOres, orderBy = "p", ranksOf = "p", topNodes = 500) %>%
        as_tibble() %>%
        mutate(p = as.double(p))
}
```

```{r runGOanalysis}
# run the analysis
df <- data %>%
    map(get.geneList) %>%
    tibble::enframe(name = "dataset", value = "genelist") %>%
    mutate(topGO = map2(genelist, dataset, make.topGO)) %>%
    mutate(res = map(topGO, get.results))

df <- df %>%
    pull(res) %>%
    set_names(df$dataset) %>%
    map(select, c("GO.ID", "Term", 'p')) %>%
    purrr::reduce(.f = full_join, by = c("GO.ID", "Term")) %>%
    magrittr::set_colnames(c("GO.ID", "Term", paste0("p_", df$dataset))) %>%
    mutate_if(is.double, function(x) tidyr::replace_na(x, 1)) %>%
    filter_if(~ all(is.double(.)), any_vars(. < .001))
```


```{r upset}
df %>%
    mutate_if(is.double, function(x) as.integer(x < .001)) %>%
    as.data.frame() %>%
    magrittr::set_rownames(.$GO.ID) %>%
    `[`(, c(-1, -2)) %>%
    upset()
```

Cutoff : p < .001, ohne Korrektur für multiples Testen.

Die für den ONT Datensatz gefundenen GO-Terme überschneiden sich zwischen Tx- und
Geneben zum Großteil. Beim Illumina Datensatz sieht das ander aus: Der Großteil
wird nur entweder auf Tx- oder auf Genebene gefunden.

Die meisten der im ONT-Datensatz identifizierten GO-Terme wurde auch im Illumina-
Datensatz gefunden.

```{r tableGO}
df %>%
    arrange(p_illumina_gene) %>%
    knitr::kable(format = "html", format.args = list(digits = 3)) %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

```{r heatmap, fig.width=14, fig.height=12}
library("pheatmap")
hclust_df <- df %>%
    mutate_if(is.numeric, function(x) -log10(x)) %>%
    as.data.frame() %>%
    magrittr::set_rownames(.$Term) %>%
    dplyr::select(-GO.ID, -Term)

myColor <- grDevices::colorRampPalette(viridis::viridis(n = 7))(100)

# plot heatmap
hclust <- pheatmap(hclust_df,
    fontfamily = "Palatino",
    clustering_method = "ward.D2",
    clustering_distance_rows = "correlation",
    show_rownames = TRUE, show_colnames = TRUE,
    color = myColor,
    lwd = .2,
    border_color = NA)

hclust
```

Die Terme, die nur von illumina_Tx gefunden werden, haben Muskulatur gemeinsam.

# Reactome

```{r reactomeAnnotation}
ensembl = biomaRt::useMart("ensembl",dataset="mmusculus_gene_ensembl")
annotation <- data %>%
    purrr::reduce(.f = full_join, by = "ensembl_gene_id_version") %>%
    pull(ensembl_gene_id_version) %>%
    unique() %>%
    biomaRt::getBM(
        attributes = c("entrezgene_id", "ensembl_gene_id_version"),
        filters = "ensembl_gene_id_version",
        values = .,
        mart = ensembl)
```

```{r reactome}
call_reactome <- function(sig, ref) {
    enrichPathway(gene = sig, universe = ref,
        organism = "mouse",
        pvalueCutoff = 0.2,
        pAdjustMethod = "BH", qvalueCutoff = 0.2,
        readable = TRUE)
}

df_reactome <- data %>%
    map(left_join, annotation, by = "ensembl_gene_id_version") %>%
    tibble::enframe(name = "dataset", value = "deseq_res") %>%
    mutate(ref_genes = map(deseq_res, pull, "entrezgene_id")) %>%
    mutate(ref_genes = map(ref_genes, as.character)) %>%
    mutate(deseq_res = map(deseq_res, select, "entrezgene_id", "log2FoldChange", "svalue")) %>%
    mutate(deseq_res = map(deseq_res, filter, svalue < .001)) %>%
    mutate(sig_genes = map(deseq_res, pull, "entrezgene_id")) %>%
    mutate(sig_genes = map(sig_genes, as.character)) %>%
    mutate(logFC = map(deseq_res, pull, "log2FoldChange")) %>%
    mutate(sig_genes = map(sig_genes, `names<-`, logFC)) %>%
    mutate(res =  map2(sig_genes, ref_genes, call_reactome))

df_reactome <- df_reactome %>%
    pull(res) %>%
    set_names(df_reactome$dataset) %>%
    map(as_tibble) %>%
    map(select, c("ID", "Description", 'qvalue')) %>%
    purrr::reduce(.f = full_join, by = c("ID", "Description")) %>%
    magrittr::set_colnames(c("ID", "Description", paste0("q_", df_reactome$dataset))) %>%
    mutate_if(is.double, function(x) tidyr::replace_na(x, 1)) %>%
    filter_if(~ all(is.double(.)), any_vars(. < .05))

df_reactome %>%
    knitr::kable(format = "html", format.args = list(digits = 3)) %>%
    kableExtra::kable_styling()
```
