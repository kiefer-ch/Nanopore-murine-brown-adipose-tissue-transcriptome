---
title: "Nanopore iBAT, read lengths, fastq"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
        fig_caption: false
        dev: "svg"
editor_options:
    chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
    cache = FALSE, out.width = 800)
```

```{r loadPackages, include=FALSE}
source(".Rprofile")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggthemes")
library("scales")
```

# Length of reads by method

These plots are based on the fastq files from the ont data. 

The illumina values are estimated based on the tpm values from salmon. They are
somewhat a reference, but not actual read lengths.

```{r}
sample_info <- read_csv(snakemake@input[["sample_info"]]) %>% 
    filter(!is.na(ont)) %>%
    mutate_at(vars(matches("condition")), as.factor) %>% 
    dplyr::select(sample_id, illumina, ont, cdna) %>% 
    tidyr::gather("method", "barcode", -sample_id) %>% 
    dplyr::select(-method)
```

```{r dataImport_fastqReadLengths}
separate_variables <- function(df, method) {
    if (method %in% c("cdna", "teloprime")) {
        df <- df %>%
            tidyr::separate(sample, c("waste1", "method", "flowcell", "barcode"),
                sep = "/",
                extra = "drop") %>% 
            tidyr::separate(barcode, c("barcode"), extra = "drop") %>% 
            select_at(vars(-matches("waste")))
    } else if (method == "rna") {
        df <- df %>%
            tidyr::separate(sample, c("waste1", "method", "barcode"),
                sep = "/",
                extra = "drop") %>% 
            tidyr::separate(barcode, c("barcode"), extra = "drop") %>% 
            select_at(vars(-matches("waste"))) 
    }
    return(df)
}

df <- snakemake@input[["readLengths"]] %>% 
    map(read_csv, show_col_types = FALSE) %>%
    map(tidyr::gather, "sample", "counts", -read_length) %>% 
    map2(., c("teloprime", "cdna", "rna"), separate_variables) %>% 
    bind_rows() %>% 
    mutate(flowcell = if_else(flowcell %in% c("X1_flowcell", "pool1"), "cell_1", "cell_2")) %>% 
    mutate(flowcell = if_else(method == "rna", NA_character_, flowcell)) %>% 
    left_join(sample_info, by = "barcode") %>%
    mutate(sample_id = if_else(method == "rna", barcode, sample_id)) %>% 
    dplyr::select(-barcode) %>% 
    mutate_if(is.character, as.factor) %>% 
    filter(counts != 0)
```

```{r, fig.width = 6.85 / 2, fig.asp = .7}
tpm <- snakemake@input[["avg_counts"]] %>% 
    read_csv() %>% 
    select(transcript_length, illumina) %>% 
    rename(read_length = "transcript_length") %>%
    tidyr::drop_na() %>% 
    mutate(illumina = 2^illumina - 1) %>% 
    group_by(read_length) %>% 
    summarise(counts = sum(illumina, na.rm = TRUE)) %>% 
    mutate(method = "illumina")


df %>% 
    group_by(method, read_length) %>% 
    summarise(counts = sum(counts)) %>% 
    bind_rows(., tpm) %>% 
    mutate(method = factor(method, levels = c("illumina", "teloprime", "cdna", "rna"))) %>% 
    ggplot(aes(read_length, counts)) +
        geom_freqpoly(stat = "identity", lwd = .25) +
        facet_wrap(~method, ncol = 1, scales = "free_y") +
        scale_y_continuous(labels = label_scientific()) +
        scale_x_log10(labels = trans_format("log10", math_format(10^.x))) +
        ylab("Reads") + 
        xlab("Read length") +
        theme_tufte(base_size = 8, base_family = "Helvetica") +
        geom_rangeframe(sides = "lb") 
```

```{r, fig.width = 6.85 / 2, fig.asp = .7}
df %>% 
    group_by(method, read_length) %>% 
    summarise(counts = sum(counts)) %>%
    bind_rows(tpm) %>% 
    group_by(method) %>% 
    mutate(weight = counts / sum(counts)) %>% 
    ungroup() %>% 
    mutate(method = factor(method, levels = c("illumina", "teloprime", "cdna", "rna"))) %>% 
    ggplot(aes(method, read_length, weight = weight)) +
    geom_violin(lwd = .25) +
    scale_y_log10(labels = trans_format("log10", math_format(10^.x))) +
    theme_tufte(base_size = 8, base_family = "Helvetica") +
    geom_rangeframe(sides = "bl") +
    xlab(NULL) + 
    ylab("Read/transcript length")
```

```{r}
df %>% 
    group_by(method, flowcell) %>% 
    mutate(weighted_length = read_length * counts) %>% 
    summarise(counts = sum(counts),
        sum_weigthed_readlengths = sum(weighted_length),
        max_readLength = max(read_length)) %>% 
    mutate(avg_readlength = sum_weigthed_readlengths / counts) %>% 
    dplyr::select(-sum_weigthed_readlengths) %>% 
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling()
```


# By sample

```{r readLength_Violin}
df %>% 
    group_by(method, flowcell, sample_id) %>% 
    mutate(weight = counts / sum(counts)) %>% 
    ungroup() %>% 
    filter(method != "rna") %>% 
    ggplot(aes(sample_id, read_length, weight = weight, fill = flowcell)) +
    geom_violin() +
    facet_wrap(~method, ncol = 1) +
    scale_y_log10(labels = trans_format("log10", math_format(10^.x))) +
    scale_fill_brewer(palette = "Dark2") +
    theme_tufte(base_size = 8, base_family = "Helvetica") +
    geom_rangeframe(sides = "bl") +
    xlab(NULL) + 
    ylab("Read length")
```
