---
title: "Comparison of DGE, DTE and DTU"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r library, include=FALSE}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("ggplot2")
library("ggiraph")
library("UpSetR")
library("DESeq2")
    select <- dplyr::select
    rename <- dplyr::rename
```

# Data Import

I use the illumina data from only those samples also analysed on the nanopore.

```{r dataImport_illumina}
illumina_tx <- "../res/txlevel_ont/txlevel_ont_de.csv.gz"
illumina_gene <- "../res/genelevel_ont/genelevel_ont_de.csv.gz"
illumina_dtu <- "../res/dtu_ont/stageR_drimseq_dtu.csv.gz"

data <- c(snakemake@input[["illumina_tx"]], 
        snakemake@input[["illumina_gene"]], 
        snakemake@input[["illumina_dtu"]]) %>% 
    map(read_csv)
```

```{r dataImport_ont}
# dtu
ont_dtu <- read_tsv((snakemake@input[["teloprime_dtu"]]))

# read counts
ont <- "../res/wien/6samples/ChrKiefer_6samples_raw_gene_counts.tsv"
ont_df <- read_tsv(ont) %>% 
    tidyr::separate(transcript, 
        c("ensembl_transcript_id_version", "ensembl_gene_id_version"),
        sep = '\\|')

# rename
sample_info <- read_csv("../sample_info/sampleInfo.csv")

lookup <- sample_info$illumina
names(lookup) <- sample_info$ont
    
colnames(ont_df) <- lookup[colnames(ont_df)]
colnames(ont_df)[c(1, 2)] <- c("ensembl_transcript_id_version", "ensembl_gene_id_version")

# prepare colData 
colData <- sample_info %>% 
    mutate_all(as.factor) %>% 
    filter(!is.na(ont)) %>% 
    as.data.frame() %>% 
    magrittr::set_rownames(.$illumina)
```

```{r deseqTx}
# dds tx level
ont_counts <- as.matrix(ont_df[, c(-1, -2)])
row.names(ont_counts) <- ont_df$ensembl_transcript_id_version

dds_tx <- DESeqDataSetFromMatrix(ont_counts, colData, design = ~ condition_temp) 

colData(dds_tx)$condition_temp <- relevel(colData(dds_tx)$condition_temp, ref = "22")

# filtering lowly expressed genes and fitting models
dds_tx <- dds_tx[rowSums(counts(dds_tx)) > 10, ] %>% 
    DESeq(., parallel = TRUE)

resLFC_tx <- lfcShrink(dds_tx, 
    coef = "condition_temp_4_vs_22",
    lfcThreshold = 1,
    type = "apeglm",
    parallel = TRUE)

resLFC_tx <- resLFC_tx %>% 
    as_tibble(rownames = "ensembl_tx_id_version")

lookup <- ont_df$ensembl_gene_id_version
names(lookup) <- ont_df$ensembl_transcript_id_version

resLFC_tx <- resLFC_tx %>% 
    mutate(ensembl_gene_id_version = lookup[ensembl_tx_id_version])
```

```{r deseqGene}
# dds tx level
ont_counts <- ont_df %>% 
    tidyr::gather(key = "sample", value = "counts_ont",
        -ensembl_transcript_id_version, -ensembl_gene_id_version) %>% 
    group_by(ensembl_gene_id_version, sample) %>% 
    summarise(counts_ont = sum(counts_ont)) %>% 
    tidyr::spread(key = sample, value = counts_ont) %>% 
    filter(!is.na(ensembl_gene_id_version)) %>% 
    magrittr::set_rownames(.$ensembl_gene_id_version) %>% 
    as.matrix() %>% 
    `[`( ,-1)

class(ont_counts) <- "numeric"

dds_gene <- DESeqDataSetFromMatrix(ont_counts, colData, design = ~ condition_temp) 
colData(dds_gene)$condition_temp <- relevel(colData(dds_gene)$condition_temp, ref = "22")

# filtering lowly expressed genes and fitting models
dds_gene <- dds_gene[rowSums(counts(dds_gene)) > 10, ] %>% 
    DESeq(., parallel = TRUE)

resLFC_gene <- lfcShrink(dds_gene, 
    coef = "condition_temp_4_vs_22",
    lfcThreshold = 1,
    type = "apeglm",
    parallel = TRUE)

resLFC_gene <- resLFC_gene %>% 
    as_tibble(rownames = "ensembl_gene_id_version")
```


```{r mergeDatasets}
df <- data[[1]] %>% 
    select(-baseMean, -lfcSE) %>% 
    left_join(data[[2]] %>% select(ensembl_gene_id_version, log2FoldChange, svalue),
        by = "ensembl_gene_id_version", suffix = c("_illuminaTx", "_illuminaGene")) %>% 
    left_join(data[[3]] %>% select(ensembl_gene_id_version, ensembl_transcript_id_version,
        p_gene_illuminaDTU = "gene", p_tx_illuminaDTU = "transcript"),
        by = c("ensembl_gene_id_version", "ensembl_transcript_id_version")) %>% 
    left_join(resLFC_gene %>% select(ensembl_gene_id_version, log2FoldChange_ontGene = "log2FoldChange", svalue_ontGene = "svalue"),
        by = "ensembl_gene_id_version") %>% 
    left_join(resLFC_tx %>% select(ensembl_gene_id_version, ensembl_transcript_id_version = "ensembl_tx_id_version",
            log2FoldChange_ontTx = "log2FoldChange", svalue_ontTx = "svalue"),
        by = c("ensembl_gene_id_version", "ensembl_transcript_id_version")) %>% 
    left_join(ont_dtu %>% select(ensembl_gene_id_version = "geneID", ensembl_transcript_id_version = "txID",
            p_gene_ontDTU = "gene", p_tx_ontDTU = "transcript"),
        by = c("ensembl_gene_id_version", "ensembl_transcript_id_version"))
```    

# Intersections

Analysis on gene level. The txlevel pvalues are the smallest for any of the transcripts
of a gene.

The ont DTE and DGE values have been caluclated with the same settings as used for
the illumina data.

```{r upset}
df %>%
    mutate_at(vars(matches("value|p_")), function(x) tidyr::replace_na(x, 1)) %>% 
    group_by(ensembl_gene_id_version) %>% 
    summarise(svalue_illuminaTx = min(svalue_illuminaTx),
        svalue_illuminaGene = min(svalue_illuminaGene),
        p_gene_illuminaDTU = min(p_gene_illuminaDTU), 
        p_tx_illuminaDTU = min(p_tx_illuminaDTU),
        svalue_ontTx = min(svalue_ontTx),
        svalue_ontGene = min(svalue_ontGene),
        p_gene_ontDTU = min(p_gene_ontDTU), 
        p_tx_ontDTU = min(p_tx_ontDTU)) %>% 
    mutate_if(is.double, function(x) as.integer(x < .05)) %>%
    tidyr::drop_na(ensembl_gene_id_version) %>%
    as.data.frame() %>% 
    magrittr::set_rownames(.$ensembl_gene_id_version) %>% 
    `[`(, -1) %>% 
    upset(nsets = 8, nintersects = 50, keep.order = TRUE)
```

The take home message is: There is not much overlap between the genes detected 
by ont and illumina.

# All genes whith any significant score

TPM cutoff = 10

```{r}
df_anysig <- df %>% 
    filter_at(vars(matches("value|p_")), any_vars(. < .05)) %>% 
    mutate_at(vars(matches("value|p_")), function(x) tidyr::replace_na(x, 1)) %>% 
    tidyr::drop_na(ensembl_gene_id_version) %>%
    group_by(ensembl_gene_id_version) %>% 
    summarise(mgi_symbol = unique(mgi_symbol), description = unique(description),
        gene_biotype = unique(gene_biotype), baseTPM = mean(baseTPM), 
        svalue_illuminaTx = min(svalue_illuminaTx),
        svalue_illuminaGene = min(svalue_illuminaGene),
        p_gene_illuminaDTU = min(p_gene_illuminaDTU), 
        p_tx_illuminaDTU = min(p_tx_illuminaDTU),
        svalue_ontTx = min(svalue_ontTx),
        svalue_ontGene = min(svalue_ontGene),
        p_gene_ontDTU = min(p_gene_ontDTU), 
        p_tx_ontDTU = min(p_tx_ontDTU)) %>% 
    filter(baseTPM > 10)

df_anysig %>% 
    kableExtra::kable(format = "html") %>% 
    kableExtra::kable_styling() %>% 
    kableExtra::scroll_box(width = "100%", height = "600px")

```
