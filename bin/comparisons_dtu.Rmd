---
title: "Comparison of DTU"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r library, include=FALSE}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("UpSetR")
    select <- dplyr::select
    rename <- dplyr::rename
```

```{r dataImport}
# chip
chip <- read_csv(snakemake@input[["chip"]]) %>% 
    mutate_if(is.numeric, function(x) x > 1) %>% 
    rowwise() %>% 
    mutate(has_multiple_peaks = any(NW_broad.bed_fullRange, NC_broad.bed_fullRange)) %>% 
    select(ensembl_gene_id_version, has_multiple_peaks)

# dexseq 
dexseq <- c(snakemake@input[["illumina_dex"]],
            snakemake@input[["teloprime_dex"]]) %>% 
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>% 
    as.list() %>% 
    map(read_csv) %>% 
    map(select, ensembl_gene_id_version, padj) %>% 
    bind_rows(.id = "dataset") %>% 
    tidyr::spread(dataset, padj)

# drimseq
drimseq <- c(snakemake@input[["illumina_drim"]],
             snakemake@input[["teloprime_drim"]],
             snakemake@input[["teloprime_drim_flair"]]) %>% 
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>% 
    as.list() %>% 
    map(read_csv) %>%
    map(select, ensembl_gene_id_version, padj = "gene") %>% 
    map(group_by, ensembl_gene_id_version) %>% 
    map(summarise, padj = min(padj)) %>% 
    bind_rows(.id = "dataset") %>% 
    tidyr::spread(dataset, padj)

df <- drimseq %>% 
    full_join(dexseq, by = "ensembl_gene_id_version") %>% 
    full_join(chip, by = "ensembl_gene_id_version") %>% 
    mutate_if(is.numeric, function(x) tidyr::replace_na(x, 1)) %>% 
    filter(substr(ensembl_gene_id_version, 1, 3) != "chr")
```

# All genes

has_multiple_peaks means there is more than one h3k4me3 peak over the gene body
of a gene.

Multiple peaks are indicators of multiple TSS. The other methods identify not
alternative TSS but also alternative splicing and alternative TES.

```{r upset_withChip}
df %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    mutate(has_multiple_peaks = as.integer(has_multiple_peaks)) %>% 
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 6, keep.order = TRUE,
        scale.intersections = "log10",
        scale.sets = "log10",
        sets.bar.color = c("green", rep(c("red", "blue"), c(2, 3))),
        nintersects = 14,
        order.by = "freq")
```

#### Without chip

```{r}
df %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    mutate(has_multiple_peaks = as.integer(has_multiple_peaks)) %>% 
    select(-has_multiple_peaks) %>% 
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 5, keep.order = TRUE,
        sets.bar.color = c(rep(c("red", "blue"), c(2, 3))),
        nintersects = 14,
        order.by = "freq")
```

<!-- # Subset to only those genes with multiple chip peaks -->

<!-- ```{r subset} -->
<!-- df_sub <- df %>%  -->
<!--     filter(has_multiple_peaks) %>%  -->
<!--     select(-has_multiple_peaks) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df_sub %>%  -->
<!--     mutate_if(is.numeric, function(x) as.integer(x < .05)) %>% -->
<!--     as.data.frame() %>% -->
<!--     tibble::column_to_rownames("ensembl_gene_id_version") %>%  -->
<!--     upset(nsets = 4, keep.order = TRUE, -->
<!--         sets.bar.color = c(rep(c("red", "blue"), each = 2)), -->
<!--         nintersects = 14, -->
<!--         order.by = "freq") -->
<!-- ``` -->

#### List of genes that show DTU in any of the analyses

```{r}
biomart <- read_rds(snakemake@input[["biomaRt_gene"]])
```

```{r}
df_sub <- df %>% 
    left_join(biomart, by = "ensembl_gene_id_version") %>% 
    select(ensembl_gene_id_version, mgi_symbol, description, gene_biotype, everything()) %>% 
    arrange(illumina_dexseq_results)

df_sub %>% 
    filter_if(is.numeric, any_vars(. < .05)) %>%
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")

df_sub %>% 
    write_csv("res/comparisons/comparisons_dtu.csv")
```
