---
title: "Comparison of DTU"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r library, include=FALSE}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("UpSetR")
    select <- dplyr::select
    rename <- dplyr::rename
```

```{r dataImport}
# chip
chip <- read_csv(snakemake@input[["chip"]]) %>% 
    mutate_if(is.numeric, function(x) x > 1) %>% 
    rowwise() %>% 
    mutate(has_multiple_peaks = any(NW_broad.bed_fullRange, NC_broad.bed_fullRange)) %>% 
    select(ensembl_gene_id_version, has_multiple_peaks)

# dexseq 
dexseq <- c(snakemake@input[["illumina_dex"]], snakemake@input[["teloprime_dex"]]) %>% 
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>% 
    as.list() %>% 
    map(read_csv) %>% 
    map(select, ensembl_gene_id_version, padj) %>% 
    bind_rows(.id = "dataset") %>% 
    tidyr::spread(dataset, padj)

# drimseq
drimseq_teloprime <- read_tsv(snakemake@input[["teloprime_drim"]]) %>% 
    rename(mgi_symbol = "GeneSymbol",
        ensembl_gene_id_version = "geneID",
        ensembl_transcript_id_version = "txID")

drimseq <- snakemake@input[["illumina_drim"]] %>% 
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>% 
    as.list() %>% 
    map(read_csv)

drimseq[[2]] <- drimseq_teloprime
names(drimseq)[2] <- tools::file_path_sans_ext("teloprime_drimSeqStageR")

drimseq <- drimseq %>%
    map(select, ensembl_gene_id_version, padj = "gene") %>% 
    map(group_by, ensembl_gene_id_version) %>% 
    map(summarise, padj = min(padj)) %>% 
    bind_rows(.id = "dataset") %>% 
    tidyr::spread(dataset, padj)

df <- drimseq %>% 
    full_join(dexseq, by = "ensembl_gene_id_version") %>% 
    full_join(chip, by = "ensembl_gene_id_version") %>% 
    mutate_if(is.numeric, function(x) tidyr::replace_na(x, 1))
```

```{r upset}
df %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    mutate(has_multiple_peaks = as.integer(has_multiple_peaks)) %>% 
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 5, keep.order = TRUE,
        scale.intersections = "log10",
        scale.sets = "log10",
        sets.bar.color = c("green", rep(c("red", "blue"), each = 2)),
        nintersects = 14,
        order.by = "freq")
    
df %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    mutate(has_multiple_peaks = as.integer(has_multiple_peaks)) %>% 
    select(-has_multiple_peaks) %>% 
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 5, keep.order = TRUE,
        sets.bar.color = c(rep(c("red", "blue"), each = 2)),
        nintersects = 14,
        order.by = "freq")
```

