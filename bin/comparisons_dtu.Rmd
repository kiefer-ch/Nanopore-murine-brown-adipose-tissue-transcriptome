---
title: "Comparison of DTU"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r library, include=FALSE}
source("packrat/init.R")
library("dplyr")
library("readr")
library("purrr")
library("UpSetR")
    select <- dplyr::select
    rename <- dplyr::rename
```

```{r dataImport}
# dexseq 
dexseq <- snakemake@input[["dexseq"]] %>% 
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>% 
    map(read_csv) %>% 
    bind_rows(.id = "dataset") %>% 
    select(-mgi_symbol, -pvalue, -description) %>% 
    tidyr::separate(dataset, c("dataset", "library"), extra = "drop") %>% 
    tidyr::unite("method", dataset, library) %>% 
    tidyr::spread(method, padj)

# drimseq
drimseq <- snakemake@input[["drimseq"]] %>% 
    set_names(., tools::file_path_sans_ext(basename(.), compression = TRUE)) %>% 
    map(read_csv) %>% 
    map(select, -mgi_symbol, -transcript, -description) %>% 
    bind_rows(.id = "dataset") %>% 
    group_by(dataset, ensembl_gene_id_version) %>% 
    summarise(gene_biotype = unique(gene_biotype),
        padj = min(gene)) %>% 
    tidyr::separate(dataset, c("dataset", "flair"), extra = "drop") %>% 
    mutate(library = "drimseq") %>% 
    mutate(dataset = if_else(flair == "flair", paste0(dataset, "_flair"), dataset)) %>% 
    select(-flair) %>% 
    tidyr::unite("method", dataset, library) %>% 
    tidyr::spread(method, padj) %>% 
    filter(substr(ensembl_gene_id_version, 1, 3) == "ENS") 

df <- list(drimseq, dexseq) %>%
    reduce(full_join, by = c("ensembl_gene_id_version", "gene_biotype")) %>%
    mutate_if(is.numeric, function(x) tidyr::replace_na(x, 1))
```

# All datasets

```{r}
df %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 8,
        nintersects = 204,
        order.by = "freq")
```

```{r}
df %>% 
    select_at(vars(-matches("illumina"))) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 6,
        nintersects = 204,
        order.by = "freq")
```

```{r}
df %>% 
    select_at(vars(-matches("drimseq"))) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 6,
        nintersects = 204,
        order.by = "freq")
```

```{r}
df %>% 
    select_at(vars(-matches("dexseq"))) %>% 
    mutate_if(is.numeric, function(x) as.integer(x < .05)) %>%
    as.data.frame() %>%
    tibble::column_to_rownames("ensembl_gene_id_version") %>% 
    upset(nsets = 6,
        nintersects = 204,
        order.by = "freq")
```

#### List of genes that show DTU in any of the analyses

```{r}
biomart <- read_rds(snakemake@input[["biomaRt_gene"]])
```

```{r}
df_sub <- df %>%
    select(-gene_biotype) %>% 
    left_join(biomart, by = "ensembl_gene_id_version") %>% 
    select(ensembl_gene_id_version, mgi_symbol, description, gene_biotype, everything()) %>% 
    arrange(illumina_dexseq)

df_sub %>% 
    filter_if(is.numeric, any_vars(. < .05)) %>%
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")

counts <- read_csv(snakemake@input[["counts"]]) %>% 
    dplyr::select(-mgi_symbol, -description, -gene_biotype, -grouped_biotype) %>%
    tidyr::gather("dataset", "counts", -ensembl_gene_id_version) %>% 
    mutate(counts = 2^counts - 1) %>% 
    mutate(dataset = if_else(dataset == "illumina", 
        paste0("avgTpm_", dataset),
        paste0("avgCounts_", dataset))) %>% 
    tidyr::spread(dataset, counts)


df_sub %>% 
    rename_if(is.numeric, paste0, "_padj") %>% 
    left_join(counts, by = "ensembl_gene_id_version") %>% 
    dplyr::select(ensembl_gene_id_version, mgi_symbol, description,
        gene_biotype, avgCounts_cdna, avgCounts_teloprime,
        avgTpm_illumina, everything()) %>% 
    write_csv("res/comparisons/comparisons_dtu.csv")
```
