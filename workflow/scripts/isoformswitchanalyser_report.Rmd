---
title: "Isoformswitchanalyser results"
author: "Christoph Kiefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
        fig_caption: false
        dev: "svg"
editor_options:
    chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
    cache = FALSE, out.width = 800)
```

```{r library, include=FALSE}
source(".Rprofile")
suppressPackageStartupMessages({
    library("dplyr")
    library("readr")
    library("ggplot2")
    library("ggthemes")
    library("patchwork")
    library("DRIMSeq")
    library("IsoformSwitchAnalyzeR")
    library("org.Mm.eg.db")
    source("R/go.R")
})
```

```{r importData, include=FALSE}
sample_info <- read_csv(snakemake@input[["sample_info"]],
        show_col_types = FALSE) %>%
    filter(!is.na(ont)) %>%
    mutate_at(vars(matches("condition")), as.factor)


switchList <- read_rds(snakemake@input[["switchList"]])


switchList <- analyzePFAM(switchList,
    pathToPFAMresultFile = snakemake@input[["pfam"]],
    showProgress = FALSE)


switchList <- analyzeSwitchConsequences(switchList,
    c("intron_retention", "ORF_seq_similarity", "NMD_status",
      "domains_identified"))
```

# Results tables

```{r kableDrimSeqResults_gene}
switchList$isoformFeatures %>%
    as_tibble() %>%
    dplyr::select(gene_id,
        transcript_id = isoform_id,
        mgi_symbol = gene_name,
        gene_biotype,
        gene = gene_switch_q_value,
        transcript = isoform_switch_q_value,
        dIF,
        proportion_22 = IF1,
        proportion_4 = IF2) %>%
    filter(gene < snakemake@params$dtu_cutoff) %>%
    filter(abs(dIF) > snakemake@params$dIF_cutoff) %>%
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling() %>%
    kableExtra::scroll_box(width = "100%", height = "600px")
```

# Isoform switch analyser

## Legend

Alternative splicing (including alternative transcription start sites (ATSS) and alternative transcrip-
tion termination sites (ATTS)) are classified for each isoform comparing that isoform to the hypothetical
pre-RNA generated by combining all the exons (after exclusion of retained introns) within
a gene. Retained introns is defined as when one "exon" of one isoform overlaps two separate exons
in other isoform.

Since the comparison is to the hypothetical pre-RNA the interpretation of an event is as follows:

* ES: Exon Skipping. Compared to the hypothetical pre-RNA a single exon was skipped in the
isoform analyzed (for every ES event annotated).
* MEE: Mutually exclusive exon. Special case were two isoforms form the same gene contains
two mutually exclusive exons and which are not found in any of the other isoforms from that
gene.
* MES: Multiple Exon Skipping. Compared to the hypothetical pre-RNA multiple consecutive
exon was skipped in the isoform analyzed (for every MES event annotated).
* IR: Intron Retention. Compared to the hypothetical pre-RNA an intron was retained in the
isoform analyzed.
* A5: Alternative 5’end donor site. Compared to the hypothetical pre-RNA an alternative 5’end
donor site was used. Since it is compared to the pre-RNA, the donor site used is per definition
more upstream than the the pre-RNA (the upstream exon is shorter).
* A3: Alternative 3’end acceptor site. Compared to the hypothetical pre-RNA an alternative
3’end acceptor site was used. Since it is compared to the pre-RNA, the donor site used is per
definition more downstream than the the pre-RNA (the downstream exon is shorter).
* ATSS: Alternative Transcription Start Sites. Compared to the hypothetical pre-RNA an alter-
native transcription start site was used. Since it is compared to the pre-RNA, the ATSS site
used is per definition more downstream than the pre-RNA.
* ATTS: Alternative Transcription Termination Sites. Compared to the hypothetical pre-RNA an
alternative transcription Termination sites was used. Since it is compared to the pre-RNA, the
ATTS site used is per definition more upstream than the the pre-RNA.


## Splice analysis (significant genes)

```{r, fig.width = 6.85 / 2, fig.asp = .65}
extractSplicingSummary(switchList,
        alpha = snakemake@params$dtu_cutoff,
        dIFcutoff = snakemake@params$dIF_cutoff,
        plot = FALSE,
        returnResult = TRUE) %>%
    as_tibble() %>%
    dplyr::select(AStype, splicingResult, nrGenesWithConsequences) %>%
    mutate(splicingResult = if_else(grepl("more", splicingResult), "cold", "room temperature")) %>%
    ggplot(aes(AStype, nrGenesWithConsequences)) +
    geom_bar(aes(fill = splicingResult), stat = "identity")  +
    theme_tufte(base_size = 8, base_family = "Helvetica") +
    geom_rangeframe(sides = "bl") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
    scale_fill_colorblind(name = "isoform used more at") +
    ylab("Number of genes") +
    xlab("Alternative splicing category")


extractSplicingEnrichment(switchList,
        alpha = snakemake@params$dtu_cutoff,
        dIFcutoff = snakemake@params$dIF_cutoff,
        plot = FALSE,
        returnResult = TRUE,
        returnSummary = TRUE) %>%
    as_tibble() %>%
    dplyr::select(-Comparison, -condition_1, -condition_2) %>%
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling()
```

## Genome wide splice analysis

```{r}
extractSplicingGenomeWide(switchList,
    splicingToAnalyze = c('ES', 'MES', "IR", 'ATSS', "ATTS"),
    returnResult = FALSE)
```

## Splice consequences (impact on protein)

```{r}
n_tot <- extractSwitchSummary(switchList,
        filterForConsequences = FALSE,
        dIFcutoff = 0)$nrGenes

n_consequences <- extractSwitchSummary(switchList,
        filterForConsequences = TRUE,
        dIFcutoff = 0)$nrGenes

sprintf("%s of %s genes with DTU show consequences for the predicted protein.",
    n_consequences, n_tot)

switchList$switchConsequence %>%
    as_tibble() %>%
    dplyr::select(gene_id, switchConsequence) %>%
    tidyr::drop_na() %>%
    group_by(gene_id) %>%
    summarise(switchConsequence = paste(unique(switchConsequence), collapse = ';')) %>%
    rename(gene_id = "ensembl_gene_id_version")
```

```{r, fig.width = 6.85 / 2, fig.asp = .65}
extractConsequenceSummary(switchList,
        alpha = snakemake@params$dtu_cutoff,
        dIFcutoff = snakemake@params$dIF_cutoff,
        plot = FALSE,
        returnResult = TRUE) %>%
    dplyr::select(featureCompared, switchConsequence, nrGenesWithConsequences) %>%
    ggplot(aes(featureCompared, nrGenesWithConsequences)) +
    geom_bar(aes(fill = switchConsequence), stat = "identity") +
    scale_fill_viridis_d(name = NULL) +
    ylab("Number of genes") +
    xlab(NULL) +
    theme_tufte(base_size = 8, base_family = "Helvetica") +
    geom_rangeframe(sides = "bl") +
    theme(legend.key.size = unit(.33, "cm")) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))


extractConsequenceEnrichment(switchList,
        alpha = snakemake@params$dtu_cutoff,
        dIFcutoff = snakemake@params$dIF_cutoff,
        plot = FALSE,
        returnResult = TRUE) %>%
    as_tibble() %>%
    dplyr::select(-feature, -condition_1, -condition_2) %>%
    knitr::kable(format = "html") %>%
    kableExtra::kable_styling()
```


# Plots

The proportions and counts are from drimseq and therefore only for transcripts that have passed the filter criteria.
The cross is the proportion estimated by DRIMSeq. The red transcripts are significantly changed.
Note that sometimes there is an indication of significant DTU at the genelevel, but no
single transcript changes significantly.

```{r, results="asis", fig.width = 6.85, fig.asp = .65/2}
gene_ids <- switchList$isoformFeatures %>%
    as_tibble() %>%
    filter(gene_switch_q_value < snakemake@params$dtu_cutoff) %>%
    filter(abs(dIF) > snakemake@params$dIF_cutoff) %>%
    pull(gene_id) %>%
    unique()

if(grepl("flair", snakemake@wildcards$annotation)) {

    symbols <- mapIds(
        keys = remove.version(gene_ids),
        x = org.Mm.eg.db,
        column = "SYMBOL",
        keytype = "ENSEMBL",
        multiVals = "first")

} else if(snakemake@wildcards$annotation == "ref") {

    symbols <- mapIds(
        keys = gene_ids,
        x = org.Mm.eg.db,
        column = "ENSEMBL",
        keytype = "SYMBOL",
        multiVals = "first")

} else if(grepl("stringtie", snakemake@wildcards$annotation)) {
    if(grepl("illumina", snakemake@wildcards$annotation)) {

        ens <- read_tsv(snakemake@input$illu_tmap) %>%
            dplyr::select(qry_gene_id, ref_gene_id) %>%
            tibble::deframe()       

    } else if(grepl("teloprime", snakemake@wildcards$annotation)) {

        ens <- read_tsv(snakemake@input$telo_tmap) %>%
            dplyr::select(qry_gene_id, ref_gene_id) %>%
            tibble::deframe()       

    }

    ens_ids <- ens[gene_ids]

    symbols <- mapIds(
        keys = remove.version(ens_ids),
        x = org.Mm.eg.db,
        column = "SYMBOL",
        keytype = "ENSEMBL",
        multiVals = "first")

}

for (gene in gene_ids) {

    cat('\n')  

    if(grepl("stringtie", snakemake@wildcards$annotation)) {

        cat("##", symbols[remove.version(ens_ids[gene])], ens_ids[gene], "\n")

    } else {

        cat("##", symbols[remove.version(gene)], gene, "\n")

    }


    # transcript ids for subsetting
    transcripts <- switchList$isoformFeatures %>%
        as_tibble() %>%
        filter(gene_id == gene) %>%
        pull(isoform_id)


    # plot of isoforms with domains
    switchplot <- switchPlotTranscript(
            switchList,
            gene = gene,
            dIFcutoff = snakemake@params$dIF_cutoff,
            arrowSize = .15,
            localTheme = theme_bw(base_size = 8, base_family = "Helvetica")) +
        scale_fill_colorblind() +
        ggtitle(NULL) +
        theme(legend.position = "top",
            legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm")) +
        theme(legend.key.size = unit(.33, "cm"))


    # get order of transcripts from switchplot
    order <- ggplot_build(switchplot)$layout$panel_params[[1]]$y$get_labels()

    
    # table with transcript level information
    switchList$isoformFeatures %>%
        as_tibble() %>%
        filter(isoform_id %in% order) %>%
        dplyr::select(gene_id,
            transcript_id = isoform_id,
            mgi_symbol = gene_name,
            gene_biotype,
            gene = gene_switch_q_value,
            transcript = isoform_switch_q_value,
            dIF,
            proportion_22 = IF2,
            proportion_4 = IF1) %>%
        rowwise() %>% 
        mutate(transcript_nr = which(order == transcript_id)) %>% 
        ungroup() %>% 
        arrange(transcript_nr) %>% 
        dplyr::select(transcript_nr, everything()) %>% 
        knitr::kable(format = "html") %>%
        kableExtra::kable_styling() %>%
        print()

    
    # alternative splicing info
    switchList$AlternativeSplicingAnalysis %>% 
        as_tibble() %>% 
        filter(isoform_id %in% order) %>%
        rowwise() %>% 
        mutate(transcript_nr = which(order == isoform_id)) %>% 
        ungroup() %>% 
        arrange(transcript_nr) %>% 
        dplyr::select(transcript_nr, isoform_id, ES, MEE, MES, IR, A5, A3, ATSS, ATTS) %>% 
        knitr::kable(format = "html") %>%
        kableExtra::kable_styling() %>%
        print()
    
    
    # plot of counts
    abundance_df <- switchList$isoformRepExpression %>%
        as_tibble() %>%
        filter(isoform_id %in% transcripts) %>%
        tidyr::pivot_longer(cols = ends_with("iBAT"),
            names_to = "sample_id", values_to = "abundance") %>%
        left_join(sample_info, by = "sample_id") %>%
        filter(isoform_id %in% order) %>%
        mutate(isoform_id = factor(isoform_id, levels = order)) %>%
        mutate(condition_temp = relevel(condition_temp, "22"))
    
    abundanceplot <- abundance_df %>%
        ggplot(aes(isoform_id, abundance)) +
        geom_point(aes(colour = condition_temp),
            size = .5,
            alpha = .5,
            position = position_dodge2(width = .75)) +
        stat_summary(aes(colour = condition_temp),
            fun = mean, geom = "crossbar",
            position = position_dodge(width = .75),
            width = 1,
            fatten = 1, lwd = .5) +
        stat_summary(aes(colour = condition_temp),
            geom = "errorbar", fun.data = mean_se,
            width = .75,
            lwd = .25,
            position = position_dodge(width = .75)) +
        scale_y_continuous(
            trans = "log1p",
            breaks = c(round(min(abundance_df$abundance, na.rm = TRUE)),
                1, 3, 10, 30, 100, 300, 1000,
                round(max(abundance_df$abundance, na.rm = TRUE)))) +
        theme_tufte(base_size = 8, base_family = "Helvetica") +
        geom_rangeframe(sides = 'bl') +
        xlab("Isoform") +
        ylab("Abundance") +
        scale_colour_brewer(palette = "Dark2", name = NULL,
            labels = c("22" = "22°C", "4" = "4°C")) +
        theme(legend.key.size = unit(.33, "cm")) +
        scale_x_discrete(labels = 1:20)


    # plot of usage
    usageplot <- switchList$isoformRepExpression %>%
        as_tibble() %>%
        filter(isoform_id %in% transcripts) %>%
        tidyr::pivot_longer(cols = ends_with("iBAT"),
            names_to = "sample_id", values_to = "abundance") %>%
        group_by(sample_id) %>%
        mutate(usage = abundance / sum(abundance)) %>%
        ungroup() %>%
        left_join(sample_info, by = "sample_id") %>%
        filter(isoform_id %in% order) %>%
        mutate(isoform_id = factor(isoform_id, levels = order)) %>%
        mutate(condition_temp = relevel(condition_temp, "22")) %>%
        ggplot(aes(isoform_id, usage)) +
        geom_point(aes(colour = condition_temp),
            size = .5,
            alpha = .5,
            position = position_dodge2(width = .75)) +
        stat_summary(aes(colour = condition_temp),
            fun = mean, geom = "crossbar",
            position = position_dodge(width = .75),
            width = 1,
            fatten = 1, lwd = .5) +
        stat_summary(aes(colour = condition_temp),
            geom = "errorbar", fun.data = mean_se,
            width = .75,
            lwd = .25,
            position = position_dodge(width = .75)) +
        theme_tufte(base_size = 8, base_family = "Helvetica") +
        geom_rangeframe(sides = 'bl') +
        xlab("Isoform") +
        ylab("Isoform usage") +
        scale_y_continuous(labels = scales::percent) +
        scale_x_discrete(labels = 1:20) +
        scale_colour_brewer(palette = "Dark2", name = NULL,
            labels = c("22" = "22°C", "4" = "4°C")) +
        theme(legend.key.size = unit(.33, "cm"))

    right_pl <- abundanceplot + usageplot + plot_layout(guides = 'collect') &
        theme(legend.position = "rigth")

    switchplot <- switchplot +
        scale_y_discrete()


    pl <- switchplot + right_pl +
        plot_annotation(title = gene,
            theme = theme(plot.title = element_text(size = 9)))

    print(pl)

    cat('\n')  
}
```
